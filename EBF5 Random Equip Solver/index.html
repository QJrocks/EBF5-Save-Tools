<!doctype html>
<html>
<head>
	<title>EBF5 Save File Tools</title>
	
	<script src = "localization.js"></script>
	
	<script>
		var inputFileName
		var fileString
		var fileObj
	
		//reads in the file and base64-decodes it into a usable string.
		function readFile(input) {
			let file = input.files[0]; 
			let fileReader = new FileReader(); 
			fileReader.readAsText(file); 
			fileReader.onload = function() {
				inputFileName = file.name
				fileString = atob(fileReader.result)
				fileObj = JSON.parse(fileString)
				document.getElementById("result").innerText = ""
				loadFile(false);
			}; 
			fileReader.onerror = function() {
				alert(fileReader.error);
			}; 
		}	

		function loadFile(prevLoaded) {
			calculateRandEquips(prevLoaded)
		}
		
		function saveFile() {
			let filename = inputFileName;
			let encoded = btoa(JSON.stringify(fileObj));
			let text = ""
			//Adobe's Base64 encoding default is slightly different from JavaScript's, in that every 76 characters a newline is added.
			//See https://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/mx/utils/Base64Encoder.html for more details.
			//In any case, it's important to replicate that behavior here for maximum compatibility.
			for(let x = 0; x < encoded.length; x += 76) {
				text += encoded.substring(x, x + 76);
				text += String.fromCharCode(10);
			}
			
			if(text.charCodeAt(text.length - 1) == 10) {
				text = text.substring(0, text.length - 1);
			}
			
			var pom = document.createElement('a');
			pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
			pom.setAttribute('download', filename);

			if (document.createEvent) {
				var event = document.createEvent('MouseEvents');
				event.initEvent('click', true, true);
				pom.dispatchEvent(event);
			}
			else {
				pom.click();
			}
		}

		class EquipSet {
			size = 0
			//Internally, the game uses string matching for equipment (for example, the Flame Badge's internal ID is "firebadge")
			//I'm using a more generic string system just for ease of use (less copy-pasting from game files)
			equipIDs = []
			equipSelected = []
			nameString = ""
			seedString = ""

			constructor(size, nameString) {
				this.size = size;
				this.nameString = nameString
				this.seedString = nameString.substring(1, 3)

				for (let x = 0; x < size; x++) {
					this.equipSelected.push(false);
					this.equipIDs.push(nameString + x)
				}
			}

			equipsAvailable() {
				for (let x = 0; x < this.size; x++) {
					if (this.equipSelected[x] === false) {
						return true;
					}
				}
				return false;
			}
			
			getNextEquip() {
				let randSelect = 0;
				let seed = fileObj.seed + this.seedString.charCodeAt(0) + this.seedString.charCodeAt(1);
				do
				{
					randSelect = (randSelect += seed + 1) % this.size;
					seed = Math.floor(seed / 1.1);
					if (this.equipSelected[randSelect] === false) {
						return this.equipIDs[randSelect]
					}
				} while (this.equipsAvailable() === true);
				return "invalid";
			}
			
			acquireEquip() {
				let equipID = this.getNextEquip();
				let equipIndex = this.equipIDs.indexOf(equipID)
				this.equipSelected[equipIndex] = true;
				return equipID
			}
			
			swapEquips(prevEquip) {
				let prevID = this.equipIDs.indexOf(prevEquip)
				let newEquip = this.acquireEquip()
				this.equipSelected[prevID] = false;
				return newEquip
			}
			
			markEquipped(currentEquip) {
				let equipIndex = this.equipIDs.indexOf(currentEquip)
				this.equipSelected[equipIndex] = true;
			}
		};

		function printEquips(equipArray, resultElement) {
			for(let x = 0; x < equipArray.length; x++) {
				resultElement.innerText += localization["english"][equipArray[x]];
				if(x != equipArray.length - 1) {
					resultElement.innerText += ",\xa0"
				}
			}
		}

		function calculateRandEquips(prevLoaded) {
			let swords = new EquipSet(21, 'sword');
			let staffs = new EquipSet(21, 'staff');
			let guns = new EquipSet(21, 'gun');
			let bows = new EquipSet(21, 'bow');
			let toys = new EquipSet(21, 'toy');
			let hatsM = new EquipSet(21, 'hatm');
			let armorM = new EquipSet(21, 'armorm');
			let hatsF = new EquipSet(21, 'hatf');
			let armorF = new EquipSet(21, 'armorf');
			let flairs = new EquipSet(55, 'flair');
			
			let seed = fileObj.seed
			
			let resultElement = document.getElementById("result");

			hatsM.markEquipped("hatm0");
			hatsM.markEquipped("hatm1");
			hatsM.markEquipped("hatm8");
			
			armorM.markEquipped("armorm15");
			armorM.markEquipped("armorm1");
			armorM.markEquipped("armorm8");
			
			hatsF.markEquipped("hatf0");
			hatsF.markEquipped("hatf1");
			
			armorF.markEquipped("armorf0");
			armorF.markEquipped("armorf1");
			
			let shopItems = new Array();
			shopItems.push(hatsM.acquireEquip(), hatsF.acquireEquip(), armorM.acquireEquip(), armorF.acquireEquip(), flairs.acquireEquip(), swords.acquireEquip(), staffs.acquireEquip(), guns.acquireEquip(), bows.acquireEquip(), toys.acquireEquip(), hatsM.acquireEquip(), hatsF.acquireEquip(), hatsM.acquireEquip(), hatsF.acquireEquip(), flairs.acquireEquip(), swords.acquireEquip(), staffs.acquireEquip(), bows.acquireEquip(), toys.acquireEquip(), flairs.acquireEquip(), armorM.acquireEquip(), armorF.acquireEquip())
			
			resultElement.innerText += "\nShop items: "
			printEquips(shopItems, resultElement)
			
			let mattEquips = new Array(swords.acquireEquip(), hatsM.swapEquips("hatm0"), armorM.swapEquips("armorm15"));			
			let natzEquips = new Array(staffs.acquireEquip(), hatsF.swapEquips("hatf0"), armorF.swapEquips("armorf0"));
			let lanceEquips = new Array(guns.acquireEquip(), hatsM.swapEquips("hatm8"), armorM.swapEquips("armorm8"));
			let annaEquips = new Array(bows.acquireEquip(), hatsF.swapEquips("hatf1"), armorF.swapEquips("armorf1"));
			let nolegsEquips = new Array(toys.acquireEquip(), hatsM.swapEquips("hatm1"), armorM.swapEquips("armorm1"));
			
			resultElement.innerText += "\nMatt equips: "
			printEquips(mattEquips, resultElement);
			resultElement.innerText += "\nNatz equips: "
			printEquips(natzEquips, resultElement);
			resultElement.innerText += "\nLance equips: "
			printEquips(lanceEquips, resultElement);
			resultElement.innerText += "\nAnna equips: "
			printEquips(annaEquips, resultElement);
			resultElement.innerText += "\nNoLegs equips: "
			printEquips(nolegsEquips, resultElement);
			
			/*resultElement.innerText += "\nSword Order: "
			printEquips(swordList, resultElement);
			resultElement.innerText += "\n Staff Order: "
			printEquips(staffList, resultElement);
			resultElement.innerText += "\n Gun Order: "
			printEquips(gunList, resultElement);
			resultElement.innerText += "\n Bow Order: "
			printEquips(bowList, resultElement);
			resultElement.innerText += "\n Toy Order: "
			printEquips(toyList, resultElement);
			resultElement.innerText += "\n Male Hat Order: "
			printEquips(hatsMList, resultElement);
			resultElement.innerText += "\n Male Armor Order: "
			printEquips(armorMList, resultElement);
			resultElement.innerText += "\n Female Hat Order: "
			printEquips(hatsFList, resultElement);
			resultElement.innerText += "\n Female Armor Order: "
			printEquips(armorFList, resultElement);
			resultElement.innerText += "\n Flair Order: "
			printEquips(flairList, resultElement);*/
		}
	</script>
</head>

<body>
upload da file
<br>
<input id="input" onchange = "readFile(this)" type="file" />
<br>
<input value = "Save File" onclick = "saveFile()" type=button />
<p id = "loadedButton" style = "display:none">fuck</p>
<br>
<p id = "result">wow</p>


</body>
</html>